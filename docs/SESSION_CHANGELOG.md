# LendCity Claude Integration - Session Changelog

**Date:** January 8, 2026
**Branch:** `claude/analyze-plugin-timeout-1wX6Q`
**Download:** https://github.com/scott736/lendcity-claude-integration/archive/refs/heads/claude/analyze-plugin-timeout-1wX6Q.zip

---

## Summary of Changes

This session fixed multiple bugs and implemented major enhancements to make the smart linker more intelligent while reducing API costs.

---

## 1. Bug Fixes

### 1.1 Table Name Mismatch
**Problem:** WordPress database error - table `wp_lendcity_smart_linker_catalog` doesn't exist
**Solution:** Changed table name to `wp_lendcity_catalog` in `class-external-api.php`
**File:** `includes/class-external-api.php`

### 1.2 API Keys Deleted on Plugin Update
**Problem:** Claude and TinyPNG API keys were being deleted whenever the plugin was updated
**Solution:** Added `pre_update_option` filters to preserve existing API key values when empty values are submitted
**File:** `lendcity-claude-integration.php`

```php
add_filter('pre_update_option_lendcity_claude_api_key', array($this, 'preserve_api_key'), 10, 3);
add_filter('pre_update_option_lendcity_tinypng_api_key', array($this, 'preserve_api_key'), 10, 3);

public function preserve_api_key($new_value, $old_value, $option) {
    if (empty($new_value) && !empty($old_value)) {
        return $old_value;
    }
    return sanitize_text_field($new_value);
}
```

### 1.3 Sync Timeout (503 Error)
**Problem:** Syncing 127 articles in one request caused 503 timeout
**Solution:** Implemented batched sync that processes one article at a time with real-time progress bar
**Files:**
- `includes/class-external-api.php` - Added `lendcity_get_sync_items` and `lendcity_sync_single_item` AJAX handlers
- `admin/views/settings-page.php` - Added progress bar UI

---

## 2. Architecture Change: Pinecone as Single Source of Truth

### 2.1 Removed WordPress Catalog Dependency
**Before:** WordPress stored article metadata locally and sent it to Pinecone
**After:** WordPress only sends raw post data; Claude on Vercel auto-analyzes everything

**Files Modified:**

#### `includes/class-external-api.php` - `sync_to_catalog()`
Now sends only:
- `postId`, `title`, `url`, `slug`, `content`, `contentType`
- `isPillar` (user-controlled setting)
- `publishedAt`, `updatedAt`

All metadata (topicCluster, funnelStage, targetPersona, etc.) is auto-generated by Claude on Vercel.

#### `smart-linker-api/api/smart-link.js`
Now fetches source article metadata from Pinecone instead of expecting it from WordPress:

```javascript
if (postId) {
  const sourceFromPinecone = await getArticle(postId);
  if (sourceFromPinecone) {
    sourceArticle = {
      postId,
      title: title || sourceFromPinecone.title,
      topicCluster: sourceFromPinecone.topicCluster || 'general',
      relatedClusters: sourceFromPinecone.relatedClusters || [],
      funnelStage: sourceFromPinecone.funnelStage || 'awareness',
      targetPersona: sourceFromPinecone.targetPersona || 'general'
    };
  }
}
```

---

## 3. Max Smartness Enhancements

### 3.1 Richer Summaries (1200 characters)
**File:** `smart-linker-api/lib/claude.js` - `generateSummary()`

Increased from 300 to 1200 characters with detailed prompt including:
- Main topic and central thesis
- Specific strategies, methods, or frameworks (named exactly)
- Target audience
- Concrete examples, numbers, case studies
- Geographic markets
- Financial concepts
- Property types
- Key advice and actionable takeaways

### 3.2 Anchor Suggestions (10 per article)
**File:** `smart-linker-api/lib/claude.js` - `generateAnchorSuggestions()`

Pre-generates 10 anchor text phrases per article that would work well when linking TO that article. These are stored in Pinecone and used during link selection.

Example output for a BRRRR article:
```json
["BRRRR strategy", "buy rehab rent refinance", "recycling equity", "forced appreciation", "refinance rental property", "building a rental portfolio"]
```

### 3.3 Questions Answered (5 per article)
**File:** `smart-linker-api/lib/claude.js` - `extractQuestionsAnswered()`

Extracts 5 questions that each article answers, helping match "how to..." queries in source articles to target articles.

Example output:
```json
["How do I get started with the BRRRR strategy?", "What financing options work for BRRRR?", "How do I calculate ARV for a rehab?"]
```

### 3.4 Enhanced Link Selection Prompt
**File:** `smart-linker-api/lib/claude.js` - `analyzeContentForLinking()`

Claude now receives all context when selecting links:
- Full 1200-char summary
- Suggested anchor phrases
- Questions answered
- Topics and keywords

---

## 4. Cost Optimization: Skip Unchanged Articles

**File:** `smart-linker-api/api/catalog-sync.js`

Added timestamp comparison to skip re-processing unchanged articles:

```javascript
if (isUpdate && existing.updatedAt && updatedAt) {
  const existingDate = new Date(existing.updatedAt).getTime();
  const newDate = new Date(updatedAt).getTime();

  if (existingDate >= newDate) {
    return res.status(200).json({
      success: true,
      action: 'skipped',
      postId,
      reason: 'Article has not been modified since last sync'
    });
  }
}
```

**UI Update:** `admin/views/settings-page.php`
- Shows "X unchanged articles skipped (saves API costs)" after sync

**Savings:** 5+ Claude API calls saved per unchanged article (autoAnalyze, summary, keywords, anchors, questions)

---

## 5. Files Modified Summary

| File | Changes |
|------|---------|
| `includes/class-external-api.php` | Table name fix, simplified sync, batched handlers, action passthrough |
| `lendcity-claude-integration.php` | API key preservation filters |
| `admin/views/settings-page.php` | Batched sync UI, progress bar, skipped count display |
| `smart-linker-api/api/catalog-sync.js` | Skip-unchanged logic, anchor/questions generation calls |
| `smart-linker-api/api/smart-link.js` | Fetch source metadata from Pinecone |
| `smart-linker-api/lib/claude.js` | Richer summaries, `generateAnchorSuggestions()`, `extractQuestionsAnswered()`, enhanced prompt |
| `smart-linker-api/lib/pinecone.js` | Store `suggestedAnchors` and `questionsAnswered` fields |
| `uninstall.php` | Preserve API keys and data on uninstall |

---

## 6. Commits

```
7799591 Add skip-unchanged optimization to reduce API costs
132177e Remove WordPress catalog dependency, use Pinecone as single source of truth
eb37026 Max smartness: richer summaries, anchor suggestions, questions answered
943f0f0 Enhance smart linker with richer target article context
65f15cc Add batched Pinecone sync to prevent timeout
ec418c5 Add error logging for Pinecone sync troubleshooting
82d25fe Fix API keys being deleted on plugin update
cfbf78b Fix catalog table name mismatch causing sync error
```

---

## 7. Deployment Steps

1. **Deploy Vercel API** - Push `smart-linker-api/` folder to Vercel
2. **Update WordPress Plugin** - Upload zip from GitHub link
3. **First Sync** - All articles will sync (no existing timestamps in Pinecone)
4. **Future Syncs** - Only modified articles will be re-processed (cost savings)

---

## 8. Architecture Overview

```
┌─────────────────┐     Raw Data      ┌─────────────────┐
│    WordPress    │ ─────────────────>│   Vercel API    │
│                 │                   │                 │
│  - postId       │                   │  Claude Analysis│
│  - title        │                   │  - topicCluster │
│  - content      │                   │  - funnelStage  │
│  - url          │                   │  - summary      │
│  - isPillar     │                   │  - anchors      │
│  - updatedAt    │                   │  - questions    │
└─────────────────┘                   └────────┬────────┘
                                               │
                                               v
                                      ┌─────────────────┐
                                      │    Pinecone     │
                                      │                 │
                                      │ Single Source   │
                                      │ of Truth        │
                                      └─────────────────┘
```

---

## 9. Important Notes

- **Server-side cron runs every minute** - User has this configured
- **isPillar flag** - Only user-controlled setting kept in WordPress (pages only, not posts)
- **First sync after deployment** - All 127 articles will sync (generates new metadata)
- **Subsequent syncs** - Only modified articles processed (major cost savings)
